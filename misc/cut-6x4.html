<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ™ºèƒ½å›¾ç‰‡è¾¹ç¼˜è£å‰ªä¸ç½‘æ ¼æ‹†åˆ†å·¥å…·</title>
    <link rel="canonical" href="https://misc.xplanc.org/cut-6x4"/>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            color: #333;
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
        }
        
        h1 {
            color: #2c3e50;
            margin-bottom: 10px;
            font-size: 2.5rem;
        }
        
        .subtitle {
            color: #7f8c8d;
            font-size: 1.1rem;
            max-width: 800px;
            margin: 0 auto;
            line-height: 1.6;
        }
        
        .main-content {
            display: flex;
            flex-direction: column;
            gap: 30px;
        }
        
        .upload-section {
            background-color: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }
        
        .upload-area {
            border: 3px dashed #3498db;
            border-radius: 10px;
            padding: 40px 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            margin-bottom: 20px;
        }
        
        .upload-area:hover {
            background-color: #f8f9fa;
            border-color: #2980b9;
        }
        
        .upload-icon {
            font-size: 48px;
            color: #3498db;
            margin-bottom: 15px;
        }
        
        .upload-text {
            font-size: 1.2rem;
            color: #2c3e50;
            margin-bottom: 10px;
        }
        
        .upload-hint {
            color: #7f8c8d;
            font-size: 0.9rem;
        }
        
        .file-input {
            display: none;
        }
        
        .controls {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-top: 20px;
        }
        
        button {
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 1rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .btn-primary {
            background-color: #3498db;
            color: white;
        }
        
        .btn-primary:hover {
            background-color: #2980b9;
        }
        
        .btn-success {
            background-color: #2ecc71;
            color: white;
        }
        
        .btn-success:hover {
            background-color: #27ae60;
        }
        
        .btn-secondary {
            background-color: #95a5a6;
            color: white;
        }
        
        .btn-secondary:hover {
            background-color: #7f8c8d;
        }
        
        .btn-warning {
            background-color: #f39c12;
            color: white;
        }
        
        .btn-warning:hover {
            background-color: #d68910;
        }
        
        .btn:disabled {
            background-color: #bdc3c7;
            cursor: not-allowed;
        }
        
        .section-title {
            font-size: 1.5rem;
            color: #2c3e50;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid #ecf0f1;
        }
        
        .preview-section {
            background-color: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }
        
        .preview-container {
            display: grid;
            grid-template-columns: 1fr 350px;
            gap: 30px;
        }
        
        @media (max-width: 1100px) {
            .preview-container {
                grid-template-columns: 1fr;
            }
        }
        
        .image-preview-container {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        
        .preview-image-wrapper {
            position: relative;
            border: 1px solid #ddd;
            border-radius: 8px;
            overflow: hidden;
            background-color: #f8f9fa;
            min-height: 400px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .preview-image {
            max-width: 100%;
            max-height: 500px;
            display: block;
            transition: opacity 0.3s;
        }
        
        .crop-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            border: 2px dashed rgba(52, 152, 219, 0.8);
            box-sizing: border-box;
        }
        
        .crop-dimensions {
            position: absolute;
            bottom: 10px;
            left: 50%;
            transform: translateX(-50%);
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 8px 16px;
            border-radius: 4px;
            font-size: 0.9rem;
        }
        
        .crop-controls {
            background-color: #f8f9fa;
            border-radius: 10px;
            padding: 25px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
        }
        
        .crop-control-group {
            margin-bottom: 25px;
        }
        
        .crop-control-title {
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 12px;
            display: flex;
            justify-content: space-between;
        }
        
        .crop-value {
            color: #3498db;
            font-weight: bold;
        }
        
        .crop-slider-container {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .crop-label {
            width: 60px;
            font-weight: 600;
            color: #7f8c8d;
        }
        
        .crop-slider {
            flex: 1;
            height: 8px;
            -webkit-appearance: none;
            appearance: none;
            background: #ddd;
            border-radius: 4px;
            outline: none;
        }
        
        .crop-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 22px;
            height: 22px;
            border-radius: 50%;
            background: #3498db;
            cursor: pointer;
            border: 2px solid white;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }
        
        .crop-slider::-moz-range-thumb {
            width: 22px;
            height: 22px;
            border-radius: 50%;
            background: #3498db;
            cursor: pointer;
            border: 2px solid white;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }
        
        .edge-preview {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-top: 20px;
        }
        
        .edge-item {
            background-color: #f1f2f6;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }
        
        .edge-label {
            font-weight: 600;
            color: #7f8c8d;
            margin-bottom: 5px;
        }
        
        .edge-value {
            font-size: 1.2rem;
            font-weight: bold;
            color: #2c3e50;
        }
        
        .auto-crop-options {
            margin-top: 25px;
            padding-top: 20px;
            border-top: 1px solid #ecf0f1;
        }
        
        .auto-crop-title {
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 12px;
        }
        
        .auto-crop-buttons {
            display: flex;
            gap: 10px;
        }
        
        .auto-crop-btn {
            flex: 1;
            padding: 10px;
            font-size: 0.9rem;
        }
        
        .grid-info {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
            text-align: center;
        }
        
        .grid-info p {
            margin-bottom: 8px;
            color: #2c3e50;
        }
        
        .grid-container {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 5px;
            margin-top: 20px;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 8px;
        }
        
        .grid-cell {
            aspect-ratio: 1;
            background-color: #e0e0e0;
            border: 1px solid #bdc3c7;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
            color: #7f8c8d;
            border-radius: 3px;
        }
        
        .results-section {
            background-color: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            display: none;
        }
        
        .results-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .crop-summary {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-around;
            flex-wrap: wrap;
            gap: 15px;
        }
        
        .summary-item {
            text-align: center;
        }
        
        .summary-label {
            font-weight: 600;
            color: #7f8c8d;
            margin-bottom: 5px;
            font-size: 0.9rem;
        }
        
        .summary-value {
            font-size: 1.2rem;
            font-weight: bold;
            color: #2c3e50;
        }
        
        .grid-results {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 10px;
            margin-top: 20px;
        }
        
        .result-item {
            border-radius: 5px;
            overflow: hidden;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
            aspect-ratio: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: #f8f9fa;
            position: relative;
        }
        
        .result-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .result-item .index {
            position: absolute;
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 2px 6px;
            font-size: 0.8rem;
            border-radius: 3px;
        }
        
        .download-options {
            margin-top: 25px;
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
        }
        
        footer {
            text-align: center;
            margin-top: 40px;
            padding-top: 20px;
            border-top: 1px solid #ecf0f1;
            color: #7f8c8d;
            font-size: 0.9rem;
        }
        
        @media (max-width: 768px) {
            .grid-container, .grid-results {
                grid-template-columns: repeat(4, 1fr);
            }
            
            .controls, .auto-crop-buttons, .download-options {
                flex-direction: column;
            }
            
            button {
                width: 100%;
                justify-content: center;
            }
            
            .crop-summary {
                flex-direction: column;
                align-items: center;
            }
        }
        
        @media (max-width: 480px) {
            .grid-container, .grid-results {
                grid-template-columns: repeat(3, 1fr);
            }
            
            h1 {
                font-size: 1.8rem;
            }
            
            .upload-section, .preview-section, .results-section {
                padding: 20px;
            }
            
            .preview-container {
                gap: 20px;
            }
            
            .crop-controls {
                padding: 15px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>æ™ºèƒ½å›¾ç‰‡è¾¹ç¼˜è£å‰ªä¸ç½‘æ ¼æ‹†åˆ†å·¥å…·</h1>
            <p class="subtitle">ä¸Šä¼ ä¸€å¼ å›¾ç‰‡ï¼Œæ‰‹åŠ¨è°ƒæ•´è¾¹ç¼˜è£å‰ªå€¼å»é™¤ç©ºç™½è¾¹è·ï¼Œç„¶åæŒ‰6Ã—4ç½‘æ ¼è¿›è¡Œæ‹†åˆ†</p>
            <p class="subtitle"> å‚è€ƒ <a class="subtitle" href='https://linux.do/t/topic/1291014'>https://linux.do/t/topic/1291014</a> </p>
        </header>
        
        <div class="main-content">
            <section class="upload-section">
                <h2 class="section-title">ä¸Šä¼ å›¾ç‰‡</h2>
                <div class="upload-area" id="uploadArea">
                    <div class="upload-icon">ğŸ“</div>
                    <p class="upload-text">ç‚¹å‡»é€‰æ‹©å›¾ç‰‡æˆ–æ‹–æ‹½å›¾ç‰‡åˆ°æ­¤å¤„</p>
                </div>
                <input type="file" id="fileInput" class="file-input" accept="image/*">
                
                <div class="controls">
                    <button id="cropBtn" class="btn-warning" disabled style="display: none;">
                        <span>âœ‚ï¸</span> åº”ç”¨è£å‰ªå¹¶é¢„è§ˆ
                    </button>
                    <button id="splitBtn" class="btn-primary" disabled>
                        <span>ğŸ”ª</span> æ‹†åˆ†å›¾ç‰‡
                    </button>
                    <button id="downloadAllBtn" class="btn-success" disabled>
                        <span>ğŸ“¥</span> ä¸‹è½½å…¨éƒ¨ç¢ç‰‡ (ZIP)
                    </button>
                    <button id="resetBtn" class="btn-secondary">
                        <span>ğŸ”„</span> é‡ç½®æ‰€æœ‰
                    </button>
                </div>
            </section>
            
            <section class="preview-section">
                <h2 class="section-title">è£å‰ªé¢„è§ˆä¸è®¾ç½®</h2>
                <div class="preview-container">
                    <div class="image-preview-container">
                        <div class="preview-image-wrapper">
                            <img id="originalImage" class="preview-image" alt="åŸå§‹å›¾ç‰‡é¢„è§ˆ">
                            <div id="cropOverlay" class="crop-overlay"></div>
                            <div id="cropDimensions" class="crop-dimensions">åŸå§‹å°ºå¯¸: -- Ã— --</div>
                        </div>
                        
                        <div class="grid-info">
                            <div class="crop-control-group">
                                <div class="crop-control-title">
                                    <span>è¡Œæ•°</span>
                                    <span id="rowsValue" class="crop-value">4</span>
                                </div>
                                <div class="crop-slider-container">
                                    <span class="crop-label">è¡Œæ•°:</span>
                                    <input type="range" min="0" max="20" value="4" class="crop-slider" id="rowsSlider">
                                </div>
                            </div>
                            <div class="crop-control-group">
                                <div class="crop-control-title">
                                    <span>åˆ—æ•°</span>
                                    <span id="colsValue" class="crop-value">6</span>
                                </div>
                                <div class="crop-slider-container">
                                    <span class="crop-label">åˆ—æ•°:</span>
                                    <input type="range" min="0" max="20" value="6" class="crop-slider" id="colsSlider">
                                </div>
                            </div>
                        </div>
                        
                        <div class="grid-container" id="gridPreview" style="display: none;">
                            <!-- è¿™é‡Œä¼šåŠ¨æ€ç”Ÿæˆ6x4ç½‘æ ¼é¢„è§ˆ -->
                        </div>
                    </div>
                    
                    <div class="crop-controls">
                        <div class="crop-control-group">
                            <div class="crop-control-title">
                                <span>ä¸Šè¾¹è·è£å‰ª</span>
                                <span id="topValue" class="crop-value">0px</span>
                            </div>
                            <div class="crop-slider-container">
                                <span class="crop-label">ä¸Š:</span>
                                <input type="range" min="0" max="200" value="0" class="crop-slider" id="topSlider">
                            </div>
                        </div>
                        
                        <div class="crop-control-group">
                            <div class="crop-control-title">
                                <span>ä¸‹è¾¹è·è£å‰ª</span>
                                <span id="bottomValue" class="crop-value">0px</span>
                            </div>
                            <div class="crop-slider-container">
                                <span class="crop-label">ä¸‹:</span>
                                <input type="range" min="0" max="200" value="0" class="crop-slider" id="bottomSlider">
                            </div>
                        </div>
                        
                        <div class="crop-control-group">
                            <div class="crop-control-title">
                                <span>å·¦è¾¹è·è£å‰ª</span>
                                <span id="leftValue" class="crop-value">0px</span>
                            </div>
                            <div class="crop-slider-container">
                                <span class="crop-label">å·¦:</span>
                                <input type="range" min="0" max="200" value="0" class="crop-slider" id="leftSlider">
                            </div>
                        </div>
                        
                        <div class="crop-control-group">
                            <div class="crop-control-title">
                                <span>å³è¾¹è·è£å‰ª</span>
                                <span id="rightValue" class="crop-value">0px</span>
                            </div>
                            <div class="crop-slider-container">
                                <span class="crop-label">å³:</span>
                                <input type="range" min="0" max="200" value="0" class="crop-slider" id="rightSlider">
                            </div>
                        </div>
                        
                        <div class="edge-preview">
                            <div class="edge-item">
                                <div class="edge-label">ä¸Šè¾¹è·</div>
                                <div id="topEdgeValue" class="edge-value">0px</div>
                            </div>
                            <div class="edge-item">
                                <div class="edge-label">ä¸‹è¾¹è·</div>
                                <div id="bottomEdgeValue" class="edge-value">0px</div>
                            </div>
                            <div class="edge-item">
                                <div class="edge-label">å·¦è¾¹è·</div>
                                <div id="leftEdgeValue" class="edge-value">0px</div>
                            </div>
                            <div class="edge-item">
                                <div class="edge-label">å³è¾¹è·</div>
                                <div id="rightEdgeValue" class="edge-value">0px</div>
                            </div>
                        </div>
                        
                        <div class="auto-crop-options" style="display: none;">
                            <div class="auto-crop-title">è‡ªåŠ¨è£å‰ªé€‰é¡¹</div>
                            <div class="auto-crop-buttons">
                                <button id="autoCropBtn" class="btn-primary auto-crop-btn">
                                    <span>ğŸ¤–</span> æ™ºèƒ½æ£€æµ‹è¾¹ç¼˜
                                </button>
                                <button id="resetCropBtn" class="btn-secondary auto-crop-btn">
                                    <span>â†©ï¸</span> é‡ç½®è£å‰ª
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
            
            <section class="results-section" id="resultsSection">
                <div class="results-header">
                    <h2 class="section-title">æ‹†åˆ†ç»“æœ (24ä¸ªç¢ç‰‡)</h2>
                    <div id="cropAppliedInfo" style="color: #2ecc71; font-weight: 600;">è£å‰ªå·²åº”ç”¨</div>
                </div>
                
                <div class="crop-summary">
                    <div class="summary-item">
                        <div class="summary-label">åŸå§‹å°ºå¯¸</div>
                        <div id="originalSize" class="summary-value">-- Ã— --</div>
                    </div>
                    <div class="summary-item">
                        <div class="summary-label">è£å‰ªåå°ºå¯¸</div>
                        <div id="croppedSize" class="summary-value">-- Ã— --</div>
                    </div>
                    <div class="summary-item">
                        <div class="summary-label">ä¸Šè¾¹è·è£å‰ª</div>
                        <div id="resultTopCrop" class="summary-value">0px</div>
                    </div>
                    <div class="summary-item">
                        <div class="summary-label">ä¸‹è¾¹è·è£å‰ª</div>
                        <div id="resultBottomCrop" class="summary-value">0px</div>
                    </div>
                    <div class="summary-item">
                        <div class="summary-label">å·¦è¾¹è·è£å‰ª</div>
                        <div id="resultLeftCrop" class="summary-value">0px</div>
                    </div>
                    <div class="summary-item">
                        <div class="summary-label">å³è¾¹è·è£å‰ª</div>
                        <div id="resultRightCrop" class="summary-value">0px</div>
                    </div>
                </div>
                
                <div class="grid-results" id="gridResults">
                    <!-- è¿™é‡Œä¼šåŠ¨æ€æ˜¾ç¤ºæ‹†åˆ†åçš„å›¾ç‰‡ -->
                </div>
                
                <div class="download-options">
                    <button id="downloadSingleBtn" class="btn-success">
                        <span>ğŸ“</span> é€ä¸ªä¸‹è½½ç¢ç‰‡
                    </button>
                    <button id="downloadGridBtn" class="btn-primary">
                        <span>ğŸ–¼ï¸</span> ä¸‹è½½ç½‘æ ¼åˆæˆå›¾
                    </button>
                    <button id="downloadCroppedBtn" class="btn-warning">
                        <span>âœ‚ï¸</span> ä¸‹è½½è£å‰ªååŸå›¾
                    </button>
                </div>
            </section>
        </div>
        
        <footer>
            <p>æ™ºèƒ½å›¾ç‰‡è¾¹ç¼˜è£å‰ªä¸ç½‘æ ¼æ‹†åˆ†å·¥å…· &copy; 2023 | ä½¿ç”¨HTML5 Canvaså®ç° | æ‰€æœ‰å¤„ç†å‡åœ¨æµè§ˆå™¨å®Œæˆ</p>
        </footer>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // DOMå…ƒç´ 
            const fileInput = document.getElementById('fileInput');
            const uploadArea = document.getElementById('uploadArea');
            const originalImage = document.getElementById('originalImage');
            const cropOverlay = document.getElementById('cropOverlay');
            const cropDimensions = document.getElementById('cropDimensions');
            
            // æ§åˆ¶æŒ‰é’®
            const cropBtn = document.getElementById('cropBtn');
            const splitBtn = document.getElementById('splitBtn');
            const downloadAllBtn = document.getElementById('downloadAllBtn');
            const resetBtn = document.getElementById('resetBtn');
            const downloadSingleBtn = document.getElementById('downloadSingleBtn');
            const downloadGridBtn = document.getElementById('downloadGridBtn');
            const downloadCroppedBtn = document.getElementById('downloadCroppedBtn');
            const autoCropBtn = document.getElementById('autoCropBtn');
            const resetCropBtn = document.getElementById('resetCropBtn');

            // const rowsSlider = document.getElementById('rowsSlider');
            
            // è£å‰ªæ§åˆ¶æ»‘å—
            const topSlider = document.getElementById('topSlider');
            const bottomSlider = document.getElementById('bottomSlider');
            const leftSlider = document.getElementById('leftSlider');
            const rightSlider = document.getElementById('rightSlider');
            
            // è£å‰ªå€¼æ˜¾ç¤º
            const topValue = document.getElementById('topValue');
            const bottomValue = document.getElementById('bottomValue');
            const leftValue = document.getElementById('leftValue');
            const rightValue = document.getElementById('rightValue');
            
            // è¾¹ç¼˜é¢„è§ˆå€¼
            const topEdgeValue = document.getElementById('topEdgeValue');
            const bottomEdgeValue = document.getElementById('bottomEdgeValue');
            const leftEdgeValue = document.getElementById('leftEdgeValue');
            const rightEdgeValue = document.getElementById('rightEdgeValue');
            
            // ç»“æœåŒºåŸŸæ˜¾ç¤º
            const resultsSection = document.getElementById('resultsSection');
            const gridResults = document.getElementById('gridResults');
            const gridPreview = document.getElementById('gridPreview');
            const originalSize = document.getElementById('originalSize');
            const croppedSize = document.getElementById('croppedSize');
            const resultTopCrop = document.getElementById('resultTopCrop');
            const resultBottomCrop = document.getElementById('resultBottomCrop');
            const resultLeftCrop = document.getElementById('resultLeftCrop');
            const resultRightCrop = document.getElementById('resultRightCrop');
            
            // å…¨å±€å˜é‡
            let originalImageFile = null;
            let imageDataUrl = null;
            let croppedImageDataUrl = null;
            let splitImages = [];
            let originalWidth = 0;
            let originalHeight = 0;
            let currentCropValues = { top: 0, bottom: 0, left: 0, right: 0 };
            let maxCropValues = { top: 200, bottom: 200, left: 200, right: 200 };
            
            // åˆå§‹åŒ–6x4ç½‘æ ¼é¢„è§ˆ
            function initGridPreview() {
                gridPreview.innerHTML = '';
                for (let i = 0; i < 24; i++) {
                    const cell = document.createElement('div');
                    cell.className = 'grid-cell';
                    cell.textContent = `#${i+1}`;
                    gridPreview.appendChild(cell);
                }
            }
            
            // åˆå§‹åŒ–
            initGridPreview();
            
            // ä¸Šä¼ åŒºåŸŸç‚¹å‡»äº‹ä»¶
            uploadArea.addEventListener('click', () => fileInput.click());
            
            // æ‹–æ‹½ä¸Šä¼ åŠŸèƒ½
            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.style.borderColor = '#2980b9';
                uploadArea.style.backgroundColor = '#f8f9fa';
            });
            
            uploadArea.addEventListener('dragleave', () => {
                uploadArea.style.borderColor = '#3498db';
                uploadArea.style.backgroundColor = 'transparent';
            });
            
            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.style.borderColor = '#3498db';
                uploadArea.style.backgroundColor = 'transparent';
                
                if (e.dataTransfer.files.length) {
                    const file = e.dataTransfer.files[0];
                    if (file.type.startsWith('image/')) {
                        handleImageFile(file);
                    } else {
                        alert('è¯·é€‰æ‹©å›¾ç‰‡æ–‡ä»¶ï¼');
                    }
                }
            });
            
            // æ–‡ä»¶é€‰æ‹©äº‹ä»¶
            fileInput.addEventListener('change', (e) => {
                if (e.target.files.length) {
                    const file = e.target.files[0];
                    handleImageFile(file);
                }
            });
            
            // å¤„ç†å›¾ç‰‡æ–‡ä»¶
            function handleImageFile(file) {
                
                originalImageFile = file;
                
                const reader = new FileReader();
                reader.onload = (e) => {
                    imageDataUrl = e.target.result;
                    originalImage.src = imageDataUrl;
                    
                    // å›¾ç‰‡åŠ è½½åè·å–åŸå§‹å°ºå¯¸
                    originalImage.onload = function() {
                        originalWidth = originalImage.naturalWidth;
                        originalHeight = originalImage.naturalHeight;
                        
                        // æ›´æ–°å°ºå¯¸æ˜¾ç¤º
                        cropDimensions.textContent = `åŸå§‹å°ºå¯¸: ${originalWidth} Ã— ${originalHeight}`;
                        originalSize.textContent = `${originalWidth} Ã— ${originalHeight}`;
                        
                        // æ ¹æ®å›¾ç‰‡å°ºå¯¸åŠ¨æ€è°ƒæ•´è£å‰ªæ»‘å—æœ€å¤§å€¼
                        updateCropSliderMaxValues();
                        
                        // å¯ç”¨æŒ‰é’®
                        cropBtn.disabled = false;
                        splitBtn.disabled = false;
                        
                        // é‡ç½®è£å‰ªå€¼
                        resetCropValues();
                        
                        // åº”ç”¨åˆå§‹è£å‰ªé¢„è§ˆ
                        updateCropOverlay();
                    };
                };
                reader.readAsDataURL(file);
            }
            
            // æ ¹æ®å›¾ç‰‡å°ºå¯¸æ›´æ–°è£å‰ªæ»‘å—æœ€å¤§å€¼
            function updateCropSliderMaxValues() {
                maxCropValues = {
                    top: Math.min(200, Math.floor(originalHeight * 0.4)),
                    bottom: Math.min(200, Math.floor(originalHeight * 0.4)),
                    left: Math.min(200, Math.floor(originalWidth * 0.4)),
                    right: Math.min(200, Math.floor(originalWidth * 0.4))
                };
                
                // æ›´æ–°æ»‘å—æœ€å¤§å€¼
                topSlider.max = maxCropValues.top;
                bottomSlider.max = maxCropValues.bottom;
                leftSlider.max = maxCropValues.left;
                rightSlider.max = maxCropValues.right;
                
                // é‡ç½®æ»‘å—å€¼ï¼ˆå¦‚æœå½“å‰å€¼è¶…è¿‡æœ€å¤§å€¼ï¼‰
                if (currentCropValues.top > maxCropValues.top) {
                    topSlider.value = maxCropValues.top;
                    currentCropValues.top = maxCropValues.top;
                }
                if (currentCropValues.bottom > maxCropValues.bottom) {
                    bottomSlider.value = maxCropValues.bottom;
                    currentCropValues.bottom = maxCropValues.bottom;
                }
                if (currentCropValues.left > maxCropValues.left) {
                    leftSlider.value = maxCropValues.left;
                    currentCropValues.left = maxCropValues.left;
                }
                if (currentCropValues.right > maxCropValues.right) {
                    rightSlider.value = maxCropValues.right;
                    currentCropValues.right = maxCropValues.right;
                }
                
                // æ›´æ–°æ˜¾ç¤ºå€¼
                updateCropValueDisplays();
            }
            
            // é‡ç½®è£å‰ªå€¼
            function resetCropValues() {
                topSlider.value = 0;
                bottomSlider.value = 0;
                leftSlider.value = 0;
                rightSlider.value = 0;
                
                currentCropValues = { top: 0, bottom: 0, left: 0, right: 0 };
                
                updateCropValueDisplays();
                updateCropOverlay();
            }
            
            // æ›´æ–°è£å‰ªå€¼æ˜¾ç¤º
            function updateCropValueDisplays() {
                topValue.textContent = `${currentCropValues.top}px`;
                bottomValue.textContent = `${currentCropValues.bottom}px`;
                leftValue.textContent = `${currentCropValues.left}px`;
                rightValue.textContent = `${currentCropValues.right}px`;
                
                topEdgeValue.textContent = `${currentCropValues.top}px`;
                bottomEdgeValue.textContent = `${currentCropValues.bottom}px`;
                leftEdgeValue.textContent = `${currentCropValues.left}px`;
                rightEdgeValue.textContent = `${currentCropValues.right}px`;
            }
            
            // æ›´æ–°è£å‰ªè¦†ç›–å±‚
            function updateCropOverlay() {
                if (originalWidth === 0 || originalHeight === 0) return;
                
                // è®¡ç®—è£å‰ªåçš„æ˜¾ç¤ºåŒºåŸŸ
                const containerWidth = originalImage.parentElement.clientWidth;
                const containerHeight = originalImage.parentElement.clientHeight;
                
                // è®¡ç®—å›¾ç‰‡åœ¨å®¹å™¨ä¸­çš„æ˜¾ç¤ºå°ºå¯¸å’Œä½ç½®
                const scale = Math.min(
                    containerWidth / originalWidth,
                    containerHeight / originalHeight
                );
                
                const displayWidth = originalWidth * scale;
                const displayHeight = originalHeight * scale;
                const displayLeft = (containerWidth - displayWidth) / 2;
                const displayTop = (containerHeight - displayHeight) / 2;
                
                // è®¡ç®—è£å‰ªè¦†ç›–å±‚çš„ä½ç½®å’Œå°ºå¯¸
                const cropLeft = displayLeft + (currentCropValues.left * scale);
                const cropTop = displayTop + (currentCropValues.top * scale);
                const cropWidth = displayWidth - ((currentCropValues.left + currentCropValues.right) * scale);
                const cropHeight = displayHeight - ((currentCropValues.top + currentCropValues.bottom) * scale);
                
                // åº”ç”¨è£å‰ªè¦†ç›–å±‚æ ·å¼
                cropOverlay.style.left = `${cropLeft}px`;
                cropOverlay.style.top = `${cropTop}px`;
                cropOverlay.style.width = `${cropWidth}px`;
                cropOverlay.style.height = `${cropHeight}px`;
                
                // æ›´æ–°è£å‰ªå°ºå¯¸æ˜¾ç¤º
                const croppedWidth = originalWidth - currentCropValues.left - currentCropValues.right;
                const croppedHeight = originalHeight - currentCropValues.top - currentCropValues.bottom;
                cropDimensions.textContent = `è£å‰ªåå°ºå¯¸: ${croppedWidth} Ã— ${croppedHeight}`;
            }
            
            rowsSlider.addEventListener('input', () => {
                rowsValue.innerText = rowsSlider.value;
            });

            colsSlider.addEventListener('input', () => {
                colsValue.innerText = colsSlider.value;
            });

            // è£å‰ªæ»‘å—äº‹ä»¶ç›‘å¬
            topSlider.addEventListener('input', function() {
                currentCropValues.top = parseInt(this.value);
                updateCropValueDisplays();
                updateCropOverlay();
            });
            
            bottomSlider.addEventListener('input', function() {
                currentCropValues.bottom = parseInt(this.value);
                updateCropValueDisplays();
                updateCropOverlay();
            });
            
            leftSlider.addEventListener('input', function() {
                currentCropValues.left = parseInt(this.value);
                updateCropValueDisplays();
                updateCropOverlay();
            });
            
            rightSlider.addEventListener('input', function() {
                currentCropValues.right = parseInt(this.value);
                updateCropValueDisplays();
                updateCropOverlay();
            });
            
            // æ™ºèƒ½æ£€æµ‹è¾¹ç¼˜ç©ºç™½ï¼ˆæ¨¡æ‹ŸåŠŸèƒ½ï¼‰
            function autoDetectEdges() {
                // åœ¨å®é™…åº”ç”¨ä¸­ï¼Œè¿™é‡Œä¼šå®ç°çœŸæ­£çš„è¾¹ç¼˜æ£€æµ‹ç®—æ³•
                // è¿™é‡Œæˆ‘ä»¬æ¨¡æ‹Ÿæ£€æµ‹ï¼Œéšæœºç”Ÿæˆä¸€äº›è£å‰ªå€¼ä½œä¸ºæ¼”ç¤º
                
                // æ¨¡æ‹Ÿæ£€æµ‹é€»è¾‘ï¼šéšæœºç”Ÿæˆè£å‰ªå€¼ï¼Œä½†ä¸è¶…è¿‡å›¾ç‰‡å°ºå¯¸çš„30%
                const maxCropPercent = 0.3;
                currentCropValues.top = Math.floor(Math.random() * (originalHeight * maxCropPercent));
                currentCropValues.bottom = Math.floor(Math.random() * (originalHeight * maxCropPercent));
                currentCropValues.left = Math.floor(Math.random() * (originalWidth * maxCropPercent));
                currentCropValues.right = Math.floor(Math.random() * (originalWidth * maxCropPercent));
                
                // ç¡®ä¿è£å‰ªå€¼ä¸è¶…è¿‡æœ€å¤§å€¼
                currentCropValues.top = Math.min(currentCropValues.top, maxCropValues.top);
                currentCropValues.bottom = Math.min(currentCropValues.bottom, maxCropValues.bottom);
                currentCropValues.left = Math.min(currentCropValues.left, maxCropValues.left);
                currentCropValues.right = Math.min(currentCropValues.right, maxCropValues.right);
                
                // æ›´æ–°æ»‘å—å’Œæ˜¾ç¤º
                topSlider.value = currentCropValues.top;
                bottomSlider.value = currentCropValues.bottom;
                leftSlider.value = currentCropValues.left;
                rightSlider.value = currentCropValues.right;
                
                updateCropValueDisplays();
                updateCropOverlay();
                
                alert('æ™ºèƒ½è¾¹ç¼˜æ£€æµ‹å®Œæˆï¼å·²è‡ªåŠ¨è®¾ç½®è£å‰ªå€¼ã€‚\n\n(æ³¨æ„ï¼šæ­¤æ¼”ç¤ºç‰ˆæœ¬ä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®ï¼Œå®é™…åº”ç”¨éœ€å®ç°çœŸæ­£çš„å›¾åƒè¾¹ç¼˜æ£€æµ‹ç®—æ³•)');
            }
            
            // åº”ç”¨è£å‰ªå¹¶é¢„è§ˆ
            function applyCropAndPreview() {
                if (!imageDataUrl) return;
                
                return new Promise((resovle) => {
                    const img = new Image();
                    img.onload = function() {
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');
                        
                        // è®¡ç®—è£å‰ªåçš„å°ºå¯¸
                        const croppedWidth = originalWidth - currentCropValues.left - currentCropValues.right;
                        const croppedHeight = originalHeight - currentCropValues.top - currentCropValues.bottom;
                        
                        // è®¾ç½®ç”»å¸ƒå°ºå¯¸ä¸ºè£å‰ªåçš„å°ºå¯¸
                        canvas.width = croppedWidth;
                        canvas.height = croppedHeight;
                        
                        // ç»˜åˆ¶è£å‰ªåçš„å›¾ç‰‡
                        ctx.drawImage(
                            img,
                            currentCropValues.left,
                            currentCropValues.top,
                            croppedWidth,
                            croppedHeight,
                            0,
                            0,
                            croppedWidth,
                            croppedHeight
                        );
                        
                        // å°†è£å‰ªåçš„å›¾ç‰‡ä¿å­˜ä¸ºæ•°æ®URL
                        croppedImageDataUrl = canvas.toDataURL('image/png');
                        
                        // æ›´æ–°ç»“æœåŒºåŸŸçš„è£å‰ªä¿¡æ¯
                        croppedSize.textContent = `${croppedWidth} Ã— ${croppedHeight}`;
                        resultTopCrop.textContent = `${currentCropValues.top}px`;
                        resultBottomCrop.textContent = `${currentCropValues.bottom}px`;
                        resultLeftCrop.textContent = `${currentCropValues.left}px`;
                        resultRightCrop.textContent = `${currentCropValues.right}px`;
                        resovle();
                    };
                    
                    img.src = imageDataUrl;
                })
                
            }
            
            // æ‹†åˆ†å›¾ç‰‡å‡½æ•°
            async function splitImageIntoGrid() {
                await applyCropAndPreview();
                if (!imageDataUrl) return;
                
                // å¦‚æœæ²¡æœ‰åº”ç”¨è£å‰ªï¼Œåˆ™ä½¿ç”¨åŸå§‹å›¾ç‰‡
                const sourceImageUrl = croppedImageDataUrl || imageDataUrl;
                
                const img = new Image();
                img.onload = function() {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    
                    // è®¾ç½®ç”»å¸ƒå¤§å°ä¸ºå›¾ç‰‡å°ºå¯¸
                    canvas.width = img.width;
                    canvas.height = img.height;
                    ctx.drawImage(img, 0, 0);
                    
                    // è®¡ç®—æ¯ä¸ªå•å…ƒæ ¼çš„å°ºå¯¸
                    const cols = colsSlider.value;
                    const rows = rowsSlider.value;
                    const cellWidth = Math.floor(img.width / cols);
                    const cellHeight = Math.floor(img.height / rows);
                    
                    // æ¸…ç©ºä¹‹å‰çš„æ‹†åˆ†ç»“æœ
                    splitImages = [];
                    gridResults.innerHTML = '';
                    
                    // åˆ›å»ºæ¯ä¸ªå•å…ƒæ ¼çš„å›¾ç‰‡
                    for (let row = 0; row < rows; row++) {
                        for (let col = 0; col < cols; col++) {
                            // åˆ›å»ºå•å…ƒæ ¼ç”»å¸ƒ
                            const cellCanvas = document.createElement('canvas');
                            cellCanvas.width = cellWidth;
                            cellCanvas.height = cellHeight;
                            const cellCtx = cellCanvas.getContext('2d');
                            
                            // ä»å›¾ç‰‡ä¸­æˆªå–å¯¹åº”åŒºåŸŸ
                            cellCtx.drawImage(
                                canvas,
                                col * cellWidth,
                                row * cellHeight,
                                cellWidth,
                                cellHeight,
                                0,
                                0,
                                cellWidth,
                                cellHeight
                            );
                            
                            // å°†ç”»å¸ƒè½¬æ¢ä¸ºæ•°æ®URL
                            const cellDataUrl = cellCanvas.toDataURL('image/png');
                            splitImages.push({
                                dataUrl: cellDataUrl,
                                row,
                                col,
                                index: row * cols + col
                            });
                            
                            // åˆ›å»ºç»“æœé¢„è§ˆå…ƒç´ 
                            const resultItem = document.createElement('div');
                            resultItem.className = 'result-item';
                            
                            const imgElement = document.createElement('img');
                            imgElement.src = cellDataUrl;
                            imgElement.alt = `ç¢ç‰‡ ${row * cols + col + 1}`;
                            imgElement.style = 'object-fit: contain';
                            
                            const indexLabel = document.createElement('div');
                            indexLabel.className = 'index';
                            indexLabel.textContent = `#${row * cols + col + 1}`;
                            
                            resultItem.appendChild(imgElement);
                            resultItem.appendChild(indexLabel);
                            gridResults.appendChild(resultItem);
                        }
                    }
                    
                    // æ˜¾ç¤ºç»“æœåŒºåŸŸ
                    resultsSection.style.display = 'block';
                    downloadAllBtn.disabled = false;
                    
                    // æ»šåŠ¨åˆ°ç»“æœåŒºåŸŸ
                    resultsSection.scrollIntoView({ behavior: 'smooth' });
                };
                
                img.src = sourceImageUrl;
            }
            
            // ä¸‹è½½æ‰€æœ‰ç¢ç‰‡ä¸ºZIP
            function downloadAllAsZip() {
                if (splitImages.length === 0) return;
                
                alert('åœ¨å®é™…åº”ç”¨ä¸­ï¼Œè¿™é‡Œä¼šä½¿ç”¨JSZipåº“åˆ›å»ºZIPæ–‡ä»¶ã€‚\n\nç”±äºè¿™æ˜¯ä¸€ä¸ªæ¼”ç¤ºï¼Œæˆ‘ä»¬å°†æä¾›é€ä¸ªä¸‹è½½åŠŸèƒ½ã€‚');
                
                // åœ¨å®é™…åº”ç”¨ä¸­ï¼Œå¯ä»¥ä½¿ç”¨JSZipåº“
                // è¿™é‡Œæˆ‘ä»¬æä¾›ä¸€ä¸ªç®€å•çš„æ›¿ä»£æ–¹æ¡ˆï¼šé€ä¸ªä¸‹è½½
                downloadSingleImages();
            }
            
            // é€ä¸ªä¸‹è½½ç¢ç‰‡
            function downloadSingleImages() {
                if (splitImages.length === 0) return;
                
                // ä½¿ç”¨å»¶è¿Ÿä¸‹è½½ï¼Œé¿å…æµè§ˆå™¨é˜»æ­¢
                let delay = 0;
                splitImages.forEach((img, index) => {
                    setTimeout(() => {
                        const link = document.createElement('a');
                        link.href = img.dataUrl;
                        link.download = `meme_${(index + 1).toString().padStart(2, '0')}.png`;
                        document.body.appendChild(link);
                        link.click();
                        document.body.removeChild(link);
                    }, delay);
                    delay += 300; // 300mså»¶è¿Ÿï¼Œé¿å…æµè§ˆå™¨é˜»æ­¢å¤šæ¬¡ä¸‹è½½
                });
            }
            
            // ä¸‹è½½ç½‘æ ¼åˆæˆå›¾
            function downloadGridImage() {
                if (splitImages.length === 0) return;
                
                const cols = 6;
                const rows = 4;
                
                // è·å–ç¬¬ä¸€ä¸ªç¢ç‰‡çš„å°ºå¯¸
                const firstImg = new Image();
                firstImg.onload = function() {
                    const cellWidth = firstImg.width;
                    const cellHeight = firstImg.height;
                    
                    // åˆ›å»ºç½‘æ ¼ç”»å¸ƒ
                    const gridCanvas = document.createElement('canvas');
                    gridCanvas.width = cellWidth * cols;
                    gridCanvas.height = cellHeight * rows;
                    const gridCtx = gridCanvas.getContext('2d');
                    
                    // åŠ è½½æ‰€æœ‰å›¾ç‰‡å¹¶ç»˜åˆ¶åˆ°ç½‘æ ¼ç”»å¸ƒ
                    let loadedCount = 0;
                    splitImages.forEach(imgData => {
                        const img = new Image();
                        img.onload = function() {
                            gridCtx.drawImage(
                                img,
                                imgData.col * cellWidth,
                                imgData.row * cellHeight
                            );
                            
                            loadedCount++;
                            
                            // æ‰€æœ‰å›¾ç‰‡åŠ è½½å®Œæˆåä¸‹è½½
                            if (loadedCount === splitImages.length) {
                                const link = document.createElement('a');
                                link.href = gridCanvas.toDataURL('image/png');
                                link.download = '6x4ç½‘æ ¼åˆæˆå›¾.png';
                                document.body.appendChild(link);
                                link.click();
                                document.body.removeChild(link);
                            }
                        };
                        img.src = imgData.dataUrl;
                    });
                };
                firstImg.src = splitImages[0].dataUrl;
            }
            
            // ä¸‹è½½è£å‰ªåçš„åŸå›¾
            function downloadCroppedImage() {
                if (!croppedImageDataUrl) {
                    alert('è¯·å…ˆåº”ç”¨è£å‰ªï¼');
                    return;
                }
                
                const link = document.createElement('a');
                link.href = croppedImageDataUrl;
                link.download = 'è£å‰ªåå›¾ç‰‡.png';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
            
            // é‡ç½®æ‰€æœ‰å†…å®¹
            function resetAll() {
                originalImage.src = '';
                fileInput.value = '';
                imageDataUrl = null;
                croppedImageDataUrl = null;
                originalWidth = 0;
                originalHeight = 0;
                splitImages = [];
                gridResults.innerHTML = '';
                resultsSection.style.display = 'none';
                cropBtn.disabled = true;
                splitBtn.disabled = true;
                downloadAllBtn.disabled = true;
                resetCropValues();
                initGridPreview();
                
                cropDimensions.textContent = 'åŸå§‹å°ºå¯¸: -- Ã— --';
                originalSize.textContent = '-- Ã— --';
                croppedSize.textContent = '-- Ã— --';
            }
            
            // äº‹ä»¶ç›‘å¬
            cropBtn.addEventListener('click', applyCropAndPreview);
            splitBtn.addEventListener('click', splitImageIntoGrid);
            downloadAllBtn.addEventListener('click', downloadAllAsZip);
            resetBtn.addEventListener('click', resetAll);
            downloadSingleBtn.addEventListener('click', downloadSingleImages);
            downloadGridBtn.addEventListener('click', downloadGridImage);
            downloadCroppedBtn.addEventListener('click', downloadCroppedImage);
            autoCropBtn.addEventListener('click', autoDetectEdges);
            resetCropBtn.addEventListener('click', resetCropValues);
            
            // çª—å£å¤§å°æ”¹å˜æ—¶æ›´æ–°è£å‰ªè¦†ç›–å±‚
            window.addEventListener('resize', updateCropOverlay);
        });
    </script>
</body>
</html>